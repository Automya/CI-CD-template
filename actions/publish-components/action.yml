name: publish-components
description: "Publishes npm packages to GitHub Packages registry."
inputs:
  node_version:
    description: "Node.js version to use"
    required: false
    default: "20"
  npm_auth_token:
    description: "NPM authentication token (typically GITHUB_TOKEN)"
    required: true
  npm_scope:
    description: "NPM scope for the package (e.g., @automya)"
    required: false
    default: "@automya"
  registry_url:
    description: "NPM registry URL"
    required: false
    default: "npm.pkg.github.com"

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        registry-url: https://${{ inputs.registry_url }}
        scope: ${{ inputs.npm_scope }}

    - name: Configure npm registry
      shell: bash
      env:
        NPM_AUTH_TOKEN: ${{ inputs.npm_auth_token }}
        REGISTRY_URL: ${{ inputs.registry_url }}
        SCOPE: ${{ inputs.npm_scope }}
      run: |
        set -euo pipefail

        echo "Configuring npm registry for GitHub Packages..."
        echo "Registry: ${REGISTRY_URL}"
        echo "Scope: ${SCOPE}"

        # Configure .npmrc for the project
        cat > .npmrc << EOF
        ${SCOPE}:registry=https://${REGISTRY_URL}/
        //${REGISTRY_URL}/:_authToken=${NPM_AUTH_TOKEN}
        EOF

        echo "Registry configuration completed"

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "Installing dependencies..."
        npm ci || npm install
        echo "Dependencies installed"

    - name: Publish to GitHub Packages
      shell: bash
      env:
        NODE_AUTH_TOKEN: ${{ inputs.npm_auth_token }}
      run: |
        set -euo pipefail
        echo "Publishing package to GitHub Packages..."
        npm publish
        echo "Package published successfully"
