name: "GCP Docker Build & Push with PR feedback"
description: "Builds and pushes Docker images to GCP Artifact Registry using Workload Identity Federation and reports back to PR comments in PRs."

runs:
  using: "composite"
  steps:
    - name: begin notification
      if: github.event_name == 'issue_comment'
      shell: bash
      run: |
        PR_NUMBER=$(jq -r '.issue.number // empty' < "$GITHUB_EVENT_PATH")
        comment() {
          MSG="$1"
          curl -s -H "Authorization: token $GH_TOKEN" \
            -X POST \
            -d "{\"body\":\"$MSG\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" > /dev/null
        }
        comment "üöÄ Iniciando Build, espere por favor..."
dev
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean GCP credential env vars
      shell: bash
      run: |
        unset GOOGLE_APPLICATION_CREDENTIALS
        unset CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
        unset GOOGLE_GHA_CREDS_PATH
        unset GCP_SA_KEY
        export GOOGLE_APPLICATION_CREDENTIALS=""
        export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=""
        export GOOGLE_GHA_CREDS_PATH=""
        export GCP_SA_KEY=""

    - name: Install gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ""
        CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ""
        GOOGLE_GHA_CREDS_PATH: ""
        GCP_SA_KEY: ""

    - name: Configure Docker for GCP
      shell: bash
      run: |
        gcloud auth configure-docker "$GCP_REGION-docker.pkg.dev" --quiet

    - name: Determine build context
      id: context
      shell: bash
      run: |
        EVENT="${{ github.event_name }}"
        TAG=""
        BRANCH=""
        SAFE_BRANCH=""
        LOGICAL_STATUS=""
        COMMENT_BODY="${{ github.event.comment.body }}"
        CLEAN_BODY="$(echo "$COMMENT_BODY" | sed -E 's/^[[:space:]]+//')"
        PR_NUMBER=$(jq -r '.issue.number // empty' < "$GITHUB_EVENT_PATH")
        JOB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        comment_pr() {
          MSG="$1"
          if [[ -n "$PR_NUMBER" ]]; then
            curl -s -H "Authorization: token $GH_TOKEN" \
              -X POST \
              -d "{\"body\":\"$MSG\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" > /dev/null
          fi
        }

        if [[ "$EVENT" == "push" && "${{ github.ref }}" == "refs/heads/dev" ]]; then
          TAG="dev"
          BRANCH="dev"

        elif [[ "$EVENT" == "issue_comment" && "$(jq -r '.issue.pull_request // empty' < "$GITHUB_EVENT_PATH")" != "" ]]; then
          if [[ "$CLEAN_BODY" =~ ^[Bb]uild($|[[:space:]]) ]]; then
            [[ "$CLEAN_BODY" =~ -t[[:space:]]+([^\ ]+) ]] && TAG="${BASH_REMATCH[1]}" || TAG=""
            [[ "$CLEAN_BODY" =~ -b[[:space:]]+([^\ ]+) ]] && BRANCH="${BASH_REMATCH[1]}" || BRANCH=""
          else
            LOGICAL_STATUS="not_build_command"
          fi

          if [[ -z "$BRANCH" ]]; then
            PR_URL=$(jq -r '.issue.pull_request.url // empty' < "$GITHUB_EVENT_PATH")
            BRANCH=$(curl -s -H "Authorization: token $GH_TOKEN" "$PR_URL" | jq -r .head.ref)
          fi

          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')

          is_semver() { [[ "$1" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; }

          # El TAG siempre ser√° el SAFE_BRANCH si no est√° expl√≠cito
          if [[ -z "$TAG" && -n "$BRANCH" ]]; then
            TAG="$SAFE_BRANCH"
          fi

          # Chequeo de errores l√≥gicos
          if [[ "$BRANCH" == "dev" && -n "$TAG" && "$TAG" != "dev" ]]; then
            if ! is_semver "$TAG"; then
              LOGICAL_STATUS="invalid_tag_dev"
            fi
          elif [[ "$BRANCH" != "dev" && -n "$TAG" ]]; then
            if is_semver "$TAG"; then
              LOGICAL_STATUS="invalid_tag_branch"
            fi
          fi

        elif [[ "$EVENT" == "release" && "${GITHUB_REF}" =~ ^refs/tags/v ]]; then
          TAG="${{ github.event.release.tag_name }}"
          BRANCH="${{ github.event.release.target_commitish }}"
          if [[ "$BRANCH" != "dev" ]]; then
            LOGICAL_STATUS="invalid_release_branch"
            comment_pr "‚ùå Error: Release con tag ${TAG} no apunta a dev. [Ver logs]($JOB_URL)"
          fi
        else
          LOGICAL_STATUS="not_supported_event"
        fi

        # Para checkout y trabajo, usar la rama real (BRANCH), para el tag docker el "SAFE_BRANCH"
        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        echo "safe_branch=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "job_url=$JOB_URL" >> "$GITHUB_OUTPUT"
        echo "status=$LOGICAL_STATUS" >> "$GITHUB_OUTPUT"

    - name: Checkout branch
      if: steps.context.outputs.branch != ''
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.context.outputs.branch }}
    - name: Authenticate to GCP using Workload Identity Federation
      uses: google-github-actions/auth@v1
      with:
        create_credentials_file: true
        workload_identity_provider: "projects/244039780319/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-automya"
        service_account: "github-ci-sa@automya.iam.gserviceaccount.com"
    - name: Build and push image
      if: steps.context.outputs.tag != ''
      id: build
      shell: bash
      run: |
        STATUS="${{ steps.context.outputs.status }}"
        if [[ "$STATUS" != "" && "$STATUS" != "success" ]]; then
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        TAG="${{ steps.context.outputs.tag }}"
        FULL_IMAGE="$GCP_REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$TAG"

        set +e  # Desactiva 'exit on error'
        docker build \
          -t "$FULL_IMAGE" .
        BUILD_STATUS=$?

        if [ $BUILD_STATUS -ne 0 ]; then
          echo "status=build_failed" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        docker push "$FULL_IMAGE"
        PUSH_STATUS=$?

        if [ $PUSH_STATUS -ne 0 ]; then
          echo "status=push_failed" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "status=success" >> "$GITHUB_OUTPUT"

    - name: Comment build result on PR
      if: github.event_name == 'issue_comment'
      shell: bash
      run: |
        PR_NUMBER=$(jq -r '.issue.number // empty' < "$GITHUB_EVENT_PATH")
        JOB_URL="${{ steps.context.outputs.job_url }}"
        STATUS="${{ steps.build.outputs.status }}"
        TAG="${{ steps.context.outputs.tag }}"
        IMAGE="$GCP_REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$TAG"

        comment() {
          MSG="$1"
          curl -s -H "Authorization: token $GH_TOKEN" \
            -X POST \
            -d "{\"body\":\"$MSG\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" > /dev/null
        }

        case "$STATUS" in
          "not_build_command")
            comment "‚ùå Error: El comando del comentario debe empezar con 'build'."
            ;;
          "invalid_tag_dev")
            comment "‚ùå Error: Solo se permiten tags sem√°nticos (v1.2.3) en dev. [Ver logs del job]($JOB_URL)"
            ;;
          "invalid_tag_branch")
            comment "‚ùå Error: Tags sem√°nticos solo est√°n permitidos en dev. [Ver logs del job]($JOB_URL)"
            ;;
          "invalid_release_branch")
            comment "‚ùå Error: Release con tag no apunta a dev. [Ver logs del job]($JOB_URL)"
            ;;
          "not_supported_event")
            comment "‚ùå Error: Tipo de evento no soportado."
            ;;
          "build_failed")
            comment "‚ùå Error: Fall√≥ la construcci√≥n de la imagen ${IMAGE}. [Ver logs del job]($JOB_URL)"
            ;;
          "push_failed")
            comment "‚ùå Error: Fall√≥ el push de la imagen ${IMAGE}. [Ver logs del job]($JOB_URL)"
            ;;
          "success")
            comment "üéâ √âxito: Imagen ${IMAGE} subida correctamente. [Ver ejecuci√≥n completa]($JOB_URL)"
            ;;
        esac