name: "GCP Docker Build & Push (No GitOps)"
description: "Builds and pushes Docker images to GCP Artifact Registry using Workload Identity Federation."
inputs:
  google_chat_webhook:
    description: "Webhook URL para notificaciones a Google Chat (opcional)."
    required: false

runs:
  using: "composite"
  steps:
    - name: Notify Start
      if: github.event_name == 'issue_comment'
      uses: Automya/CI-CD-template/internal/notify@main
      with:
        github_token: ${{ env.GH_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        webhook_url: ${{ inputs.google_chat_webhook }}
        pr_message: "üöÄ Iniciando Build, espere por favor..."
        chat_message: |
          üöÄ **Iniciando Build**
          - **Repo:** ${{ github.repository }}
          - **PR:** #${{ github.event.issue.number }}
          - [Ver Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ‚è≥ Iniciando...

    - name: Parse Comment
      if: github.event_name == 'issue_comment'
      id: parse
      uses: Automya/CI-CD-template/internal/parse-comment@main
      with:
        comment_body: ${{ github.event.comment.body }}
        command_prefix: "build"

    - name: Determine Context
      id: ctx
      uses: Automya/CI-CD-template/internal/build-context-determine@main
      with:
        event_name: ${{ github.event_name }}
        is_valid_command: ${{ steps.parse.outputs.is_valid }}
        parsed_branch: ${{ steps.parse.outputs.branch }}
        parsed_tag: ${{ steps.parse.outputs.tag }}
        github_token: ${{ env.GH_TOKEN }}

    - name: Checkout code
      if: steps.ctx.outputs.branch != ''
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.ctx.outputs.branch }}

    - name: Setup GCP & Docker
      if: steps.ctx.outputs.status == ''
      uses: Automya/CI-CD-template/internal/setup-gcp@main
      with:
        region: ${{ env.GCP_REGION }}

    - name: Build and Push
      if: steps.ctx.outputs.status == ''
      id: build
      uses: Automya/CI-CD-template/internal/docker-build-push@main
      with:
        image_full_name: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.ctx.outputs.tag }}

    - name: Prepare Report
      if: github.event_name == 'issue_comment'
      id: report
      uses: Automya/CI-CD-template/internal/build-report-message@main
      with:
        status: ${{ steps.ctx.outputs.status || steps.build.outputs.status }}
        job_url: ${{ steps.ctx.outputs.job_url }}
        image_full_name: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.ctx.outputs.tag }}

    - name: Notify Result
      if: github.event_name == 'issue_comment'
      uses: Automya/CI-CD-template/internal/notify@main
      with:
        github_token: ${{ env.GH_TOKEN }}
        pr_number: ${{ github.event.issue.number }}
        webhook_url: ${{ inputs.google_chat_webhook }}
        pr_message: ${{ steps.report.outputs.pr_message }}
        chat_message: ${{ steps.report.outputs.chat_message }}
