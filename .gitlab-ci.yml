image: docker:latest
variables:
    REPO_NAME: "CI-CD-template"
stages:
  - mirror

mirror_to_github:
  stage: mirror
  image: alpine:latest
  needs: []
  before_script:
    - apk add --no-cache git
    # Configuración global para evitar warnings
    - git config --global user.name "smartadmin"
    - git config --global user.email "smartadmin@smartpadelautomation.com"
  script:
    # Clona el repositorio actual (modo mirror conserva ramas, tags y refs)
    - git clone --mirror "$CI_REPOSITORY_URL" repo.git
    - cd repo.git
    # Configura el remote hacia GitHub con credenciales seguras
    - git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/Automya/${REPO_NAME}"
    # Empuja todo (ramas, tags, refs)
    - git push --mirror origin
  only:
    - branches
  # Evita ejecuciones simultáneas si hay muchos pushes rápidos
  resource_group: mirror_to_github
