# Template de GitLab CI para tests unitarios de Java con Gradle
# Configuración de cache para optimizar builds
# Generación de reportes de cobertura y tests

# Variables globales
variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=1"

# Definición de stages
stages:
  - test
  - coverage
  - report

# Cache para dependencias Gradle
.gradle_cache: &gradle_cache
  cache:
    key: "$CI_COMMIT_REF_SLUG-gradle"
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
    policy: pull-push

# Job base para tests Gradle
.gradle_test_base:
  image: gradle:7.6-jdk17
  stage: test
  tags:
    - test
  <<: *gradle_cache
  before_script:
    - gradle --version
    - java -version

# Tests unitarios con Gradle
unit_test_gradle:
  extends: .gradle_test_base
  script:
    - gradle test
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/
    expire_in: 1 week

# Cobertura de código con Gradle
coverage_gradle:
  extends: .gradle_test_base
  stage: coverage
  needs:
    - unit_test_gradle
    - integration_test_gradle
  script:
    - gradle test jacocoTestReport
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: jacoco
        path: build/reports/jacoco/test/jacocoTestReport.xml
    paths:
      - build/reports/jacoco/
    expire_in: 1 week
  coverage: "/Total.*?([0-9]{1,3})%/"
#
# Tests de integración con Gradle
integration_test_gradle:
  extends: .gradle_test_base
  stage: test
  script:
    - gradle integrationTest
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/integrationTest/TEST-*.xml
    paths:
      - build/test-results/integrationTest/
    expire_in: 1 week

# Análisis de calidad de código con SonarQube
sonar_analysis:
  extends: .gradle_test_base
  stage: report
  needs:
    - validate_tests_passed
  script:
    - gradle sonarqube
      -Dsonar.projectKey=$CI_PROJECT_NAME
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
  only:
    - main
    - develop
    - merge_requests

# Job de validación: solo se ejecuta si todos los tests pasan
# Este job debe ser usado como dependencia en los jobs de build
validate_tests_passed:
  stage: report
  image: alpine:latest
  script:
    - echo "All tests passed successfully"
  needs:
    - unit_test_gradle
    - integration_test_gradle
    - coverage_gradle
  when: on_success

# Job para limpiar cache (opcional)
cleanup_cache:
  stage: report
  script:
    - echo "Cache cleanup completed"
  when: manual
  allow_failure: true
