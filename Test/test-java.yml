# Template de GitLab CI para tests unitarios de Java con Gradle
# Configuración de cache para optimizar builds
# Generación de reportes de cobertura y tests

# Variables globales
variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=1"

# Definición de stages
stages:
  - test
  - coverage
  - report

# Cache para dependencias Gradle
.gradle_cache: &gradle_cache
  cache:
    key: "$CI_COMMIT_REF_SLUG-gradle"
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
    policy: pull-push

# Job base para tests Gradle
.gradle_test_base:
  image: gradle:8.5-jdk21
  stage: test
  tags:
    - test
  <<: *gradle_cache
  before_script:
    - gradle --version
    - java -version

# Tests unitarios con Gradle
test_gradle:
  extends: .gradle_test_base
  script:
    - gradle test jacocoTestReport jacocoCoverageVerification
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: jacoco
        path: "**/build/reports/jacoco/test/jacocoTestReport.xml"
      junit:
        - build/test-results/test/TEST-*.xml
    paths:
      - "**/build/test-results/"
      - "**/build/reports/jacoco/"
    expire_in: 1 week
    coverage: "/Total.*?([0-9]{1,3})%/"

# Análisis de dependencias con DependencyCheck
dependency_check:
  extends: .gradle_test_base
  stage: coverage
  needs:
    - validate_tests_passed
  script:
    - gradle dependencyCheckAnalyze
  artifacts:
    when: always
    paths:
      - "**/build/reports/dependency-check/"
    expire_in: 1 week

# Análisis de calidad de código con SonarQube
sonar_analysis:
  extends: .gradle_test_base
  stage: report
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  cache:
    key: "${CI_PROJECT_NAME}-sonar"
    paths:
      - .sonar/cache
      - .dependency-check
  needs:
    - dependency_check
  script:
    - gradle sonarqube
      -Dsonar.dependencyCheck.nvd.apiKey=$NVD_API_KEY
      -Dsonar.dependencyCheck.jsonReportPath=**/build/reports/dependency-check/dependency-check-report.json
      -Dsonar.dependencyCheck.htmlReportPath=**/build/reports/dependency-check/dependency-check-report.html
  allow_failure: true
  only:
    - main

# Job de validación: solo se ejecuta si todos los tests pasan
# Este job debe ser usado como dependencia en los jobs de build
validate_tests_passed:
  stage: report
  image: alpine:latest
  script:
    - echo "All tests passed successfully"
  needs:
    - test_gradle
  when: on_success

# Job para limpiar cache (opcional)
cleanup_cache:
  stage: report
  script:
    - echo "Cache cleanup completed"
  when: manual
  allow_failure: true
