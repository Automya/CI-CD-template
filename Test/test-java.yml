# Variables globales
variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=1"

# Definición de stages
stages:
  - analysis
  - report

# Cache para dependencias Gradle
.gradle_cache: &gradle_cache
  cache:
    key: "$CI_COMMIT_REF_SLUG-gradle"
    paths:
      - "**/.gradle/caches/"
      - "**/.gradle/wrapper/"
    policy: pull-push

# Job base para análisis Gradle
.gradle_analysis_base:
  image: gradle:8.5-jdk21
  services:
    - docker:24.0.5-dind
  tags:
    - test
  <<: *gradle_cache
  before_script:
    - gradle --version
    - java -version

# Tests y generación de reportes de cobertura
test_and_coverage_analysis:
  extends: .gradle_analysis_base
  stage: analysis
  script:
    - gradle clean test jacocoTestReport jacocoCoverageVerification --no-daemon --info
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: jacoco
        path: "**/build/reports/jacoco/test/jacocoTestReport.xml"
      junit:
        - "**/build/test-results/test/TEST-*.xml"
    paths:
      - "**/build/test-results/"
      - "**/build/reports/jacoco/"
      - "**/build/classes/"
      - "**/build/resources/"
    expire_in: 1 week
  coverage: "/Total.*?([0-9]{1,3})%/"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main"'
      when: always
    - when: never


# Análisis de calidad de código con SonarQube
sonar_analysis:
  extends: .gradle_analysis_base
  stage: report
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  cache:
    key: "${CI_PROJECT_NAME}-sonar"
    paths:
      - .sonar/cache
  needs:
    - test_and_coverage_analysis
  dependencies:
    - test_and_coverage_analysis
  script:
    - '[ -n "$SONAR_TOKEN" ] || { echo "Warning: SONAR_TOKEN no está disponible, saltando análisis SonarQube"; exit 0; }'
    - gradle sonar --no-daemon --warning-mode none
  artifacts:
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main"'
      when: always
    - when: never

  allow_failure: true
# Job de validación: solo se ejecuta si todos los análisis pasan
analysis_and_tests_passed:
  stage: report
  image: alpine:latest
  script:
    - echo "All analysis and tests passed successfully"
  needs:
    - job: test_and_coverage_analysis
      artifacts: true
    - job: sonar_analysis
  when: on_success
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main"'
      when: always
    - when: never
  
