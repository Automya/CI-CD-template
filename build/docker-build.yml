.docker_login: &docker_login
  #- echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - echo "$GCP_SERVICE_KEY_JSON" > gcloud-key.json
    - gcloud auth activate-service-account --key-file=gcloud-key.json
    - gcloud auth configure-docker europe-west1-docker.pkg.dev
.build_image:
  #image: docker:latest
  image: google/cloud-sdk:latest
  stage: build
  tags:
    - build
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq ca-certificates curl gnupg
    - install -m 0755 -d /etc/apt/keyrings
    - curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    - chmod a+r /etc/apt/keyrings/docker.gpg
    - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # 2. Update package list and install the Docker CLI
    - apt-get update -qq
    - apt-get install -y -qq docker-ce-cli
    - *docker_login
  script:
    - docker build --network=host -t "$IMAGE_NAME" .
    - docker push "$IMAGE_NAME"